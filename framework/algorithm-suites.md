[//]: # "Copyright Amazon.com Inc. or its affiliates. All Rights Reserved."
[//]: # "SPDX-License-Identifier: CC-BY-SA-4.0"

# Algorithm Suites

## Version

0.2.0

## Implementations

- [C](https://github.com/awslabs/aws-encryption-sdk-c/blob/master/source/cipher.c)
- [NodeJS](https://github.com/awslabs/aws-encryption-sdk-javascript/blob/master/modules/material-management/src/node_algorithms.ts)
- [Browser JS](https://github.com/awslabs/aws-encryption-sdk-javascript/blob/master/modules/material-management/src/web_crypto_algorithms.ts)
- [Python](https://github.com/aws/aws-encryption-sdk-python/blob/master/src/aws_encryption_sdk/identifiers.py)
- [Java](https://github.com/aws/aws-encryption-sdk-java/blob/master/src/main/java/com/amazonaws/encryptionsdk/CryptoAlgorithm.java)

## Overview

An algorithm suite is a collection of cryptographic algorithms and related values.
The algorithm suite defines the behaviors the AWS Encryption SDK MUST follow for cryptographic operations.

## Definitions

### Conventions used in this document

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
in this document are to be interpreted as described in [RFC 2119](https://tools.ietf.org/html/rfc2119).

### AES

Specification: [NIST FIPS 297](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf)

The Advanced Encryption Standard (AES) is a symmetric block cipher encryption algorithm.

### GCM

Specification: [NIST Special Publication 800-38D](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38d.pdf)

Galois/Counter Mode is a mode of operation for block ciphers that provides authenticated encryption with additional data (AEAD).

If specified to use GCM, the AWS Encryption SDK MUST use GCM with the following specifics:

- The internal block cipher is the encryption algorithm specified by the algorithm suite.

### Identity KDF

The identity key derivation function (Identity KDF) is a key derivation algorithm.

The Identity KDF MUST take a byte sequence as input,
and MUST return the input, unchanged, as output.

If included in the algorithm suite,
the algorithm suite's encryption key length MUST equal the algorithm suite's [key derivation input length](#key-derivation-input-length).

### HKDF

Specification: [RFC 5869](https://tools.ietf.org/html/rfc5869)

The HMAC-based extract-and-expand key derivation function (HKDF) is a key derivation algorithm.

#### HKDF Encryption Key

If an algorithm suite uses HKDF to derive the encryption key
the AWS Encryption SDK MUST use HKDF with the following specifics:

- The hash function MUST be specified by the [algorithm suite key derivation settings](#algorithm-suites-encryption-key-derivation-settings).
- For the extract step:
  - The input keying material MUST be the data key generated by the key provider.
  - The length of the input keying material MUST equal the [key derivation input length](#key-derivation-input-length)
    specified by the [algorithm suite encryption key derivation settings](#algorithm-suites-encryption-key-derivation-settings).
  - If there is no salt length defined for the [algorithm suite encryption key derivation commitment setting](#algorithm-suites-encryption-key-derivation-settings),
    the the salt MUST be a byte sequence of 0 as long as the hash length in bytes.
  - If salt length is defined for the [algorithm suite encryption key derivation commitment setting](#algorithm-suites-encryption-key-derivation-settings),
    the salt MUST be the [message ID](../data-format/message-header.md#message-id) with a length equal to the salt length.
- For the expand step:
  - The input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the [encryption key length](#encryption-key-length)
    specified by the [algorithm suite encryption settings](#algorithm-suites-encryption-settings).
  - If [key commitment](#key-commitment) for the [algorithm suite encryption key derivation setting](#algorithm-suites-encryption-key-derivation-settings) is True,
    then the input info MUST be the string `DERIVEKEY` as UTF8 encoded bytes.
  - If [key commitment](#key-commitment) for the [algorithm suite encryption key derivation setting](#algorithm-suites-encryption-key-derivation-settings) is False,
    the the input info MUST be a concatenation of the [algorithm suite ID](#algorithm-suite-id)
    followed by the [message ID](../data-format/message-header.md#message-id).

#### HKDF Commit Key

If an algorithm suite uses HKDF to derive the commitment key
the AWS Encryption SDK MUST use HKDF with the following specifics:

- The hash function MUST be specified by the [algorithm suite commitment settings](#algorithm-suites-commit-key-derivation-settings).
- For the extract step:
  - The input keying material MUST be the data key generated by the key provider.
  - The length of the input keying material MUST equal the [key derivation input length](#key-derivation-input-length)
    specified by the algorithm suite commit key derivation setting.
  - The salt MUST be the [message ID](../data-format/message-header.md#message-id) with a length of 256 bits.
- For the expand step:
  - The input pseudorandom key MUST be the output from the extract step.
  - The length of the output keying material MUST equal the [algorithm suite data length](#algorithm-suite-data-length)
    specified by the [supported algorithm suites](#supported-algorithm-suites).
  - The input info MUST the string `COMMITKEY` as UTF8 encoded bytes by the algorithm suite commitment settings.

For algorithm suites that support commitment,
the AWS Encryption SDK SHOULD only perform the extract step once
and use the same output from the extract step
for both the encryption key and the commitment key.

Verification of the commitment key MUST be a constant time comparison.

### ECDSA

Specification: ANS X9.62-2005
(Not available publicly, but the specification for ECDSA is replicated in [SEC 1 version 2.0](https://www.secg.org/sec1-v2.pdf).
Information about obtaining copies of ANS X9.62 is available at http://www.x9.org.)

The Elliptic Curve Digital Signature Algorithm (ECDSA) is a signature algorithm.

If specified to use ECDSA, the AWS Encryption SDK MUST use ECDSA with the following specifics:

- The elliptic curve is specified by the algorithm suite.
  The specific curves are defined in
  [Digital Signature Standard (DSS) (FIPS PUB 186-4)](https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf).
- The hash function is specified by the algorithm suite.
- When included in the [message](../data-format/message.md), the output signature value is encoded using the
  ANS.1 structure `ECDSA-Sig-Value` defined in section C.5 of [Sec 1 version 2.0](http://www.secg.org/sec1-v2.pdf):

```
ECDSA-Sig-Value ::= SEQUENCE {
    r INTEGER,
    s INTEGER
}
```

- If serialized, the binary form of the verification key is equal to the elliptic curve point Q compressed
  according to section 2.3.3 of [SEC 1 version 2.0](http://www.secg.org/sec1-v2.pdf).

## Supported Algorithm Suites

The following table includes the algorithm suites supported by the AWS Encryption SDK.
The value `00 00` is reserved
and MUST NOT be used
as an Algorithm Suite ID in the future.

| Algorithm Suite ID (hex) | Message Format Version | Algorithm Suite Data Length (bytes) |
| ------------------------ | ---------------------- | ----------------------------------- |
| 05 78                    | 2.0                    | 32                                  |
| 04 78                    | 2.0                    | 32                                  |
| 03 78                    | 1.0                    | N/A                                 |
| 03 46                    | 1.0                    | N/A                                 |
| 02 14                    | 1.0                    | N/A                                 |
| 01 78                    | 1.0                    | N/A                                 |
| 01 46                    | 1.0                    | N/A                                 |
| 01 14                    | 1.0                    | N/A                                 |
| 00 78                    | 1.0                    | N/A                                 |
| 00 46                    | 1.0                    | N/A                                 |
| 00 14                    | 1.0                    | N/A                                 |

## Algorithm Suites Encryption Key Derivation Settings

The following table includes key derivation information for supported algorithm suites.

| Algorithm Suite ID (hex) | Key Derivation Input Length (bits) | Algorithm    | Hash Function | Salt Length (bits) | Key Commitment |
| ------------------------ | ---------------------------------- | ------------ | ------------- | ------------------ | -------------- |
| 05 78                    | 256                                | HKDF         | SHA-512       | 256                | True           |
| 04 78                    | 256                                | HKDF         | SHA-512       | 256                | True           |
| 03 78                    | 256                                | HKDF         | SHA-384       | 0                  | False          |
| 03 46                    | 192                                | HKDF         | SHA-384       | 0                  | False          |
| 02 14                    | 128                                | HKDF         | SHA-256       | 0                  | False          |
| 01 78                    | 256                                | HKDF         | SHA-256       | 0                  | False          |
| 01 46                    | 192                                | HKDF         | SHA-256       | 0                  | False          |
| 01 14                    | 128                                | HKDF         | SHA-256       | 0                  | False          |
| 00 78                    | 256                                | Identity KDF | N/A           | 0                  | False          |
| 00 46                    | 192                                | Identity KDF | N/A           | 0                  | False          |
| 00 14                    | 128                                | Identity KDF | N/A           | 0                  | False          |

## Algorithm Suites Encryption Settings

The following table includes the encryption settings for supported algorithm suites.

| Algorithm Suite ID (hex) | Encryption Algorithm | Encryption Algorithm Mode | Encryption Key Length (bits) | IV Length (bytes) | Authentication Tag Length (bytes) |
| ------------------------ | -------------------- | ------------------------- | ---------------------------- | ----------------- | --------------------------------- |
| 05 78                    | AES                  | GCM                       | 256                          | 12                | 16                                |
| 04 78                    | AES                  | GCM                       | 256                          | 12                | 16                                |
| 03 78                    | AES                  | GCM                       | 256                          | 12                | 16                                |
| 03 46                    | AES                  | GCM                       | 192                          | 12                | 16                                |
| 02 14                    | AES                  | GCM                       | 128                          | 12                | 16                                |
| 01 78                    | AES                  | GCM                       | 256                          | 12                | 16                                |
| 01 46                    | AES                  | GCM                       | 192                          | 12                | 16                                |
| 01 14                    | AES                  | GCM                       | 128                          | 12                | 16                                |
| 00 78                    | AES                  | GCM                       | 256                          | 12                | 16                                |
| 00 46                    | AES                  | GCM                       | 192                          | 12                | 16                                |
| 00 14                    | AES                  | GCM                       | 128                          | 12                | 16                                |

## Algorithm Suites Commit Key Derivation Settings

The following table includes commitment information for supported algorithm suites.
These values are only relevant to algorithm suites that support [key commitment](#key-commitment).

| Algorithm Suite ID (hex) | Key Derivation Input Length (bits) | Algorithm | Hash Function | Salt Length (bits) |
| ------------------------ | ---------------------------------- | --------- | ------------- | ------------------ |
| 05 78                    | 256                                | HKDF      | SHA-512       | 256                |
| 04 78                    | 256                                | HKDF      | SHA-512       | 256                |
| 03 78                    | N/A                                | N/A       | N/A           | N/A                |
| 03 46                    | N/A                                | N/A       | N/A           | N/A                |
| 02 14                    | N/A                                | N/A       | N/A           | N/A                |
| 01 78                    | N/A                                | N/A       | N/A           | N/A                |
| 01 46                    | N/A                                | N/A       | N/A           | N/A                |
| 01 14                    | N/A                                | N/A       | N/A           | N/A                |
| 00 78                    | N/A                                | N/A       | N/A           | N/A                |
| 00 46                    | N/A                                | N/A       | N/A           | N/A                |
| 00 14                    | N/A                                | N/A       | N/A           | N/A                |

## Algorithm Suites Signature Settings

The following table includes signature information for supported algorithm suites.

| Algorithm Suite ID (hex) | Signature Algorithm          |
| ------------------------ | ---------------------------- |
| 05 78                    | ECDSA with P-384 and SHA-384 |
| 04 78                    | Not applicable               |
| 03 78                    | ECDSA with P-384 and SHA-384 |
| 03 46                    | ECDSA with P-384 and SHA-384 |
| 02 14                    | ECDSA with P-256 and SHA-256 |
| 01 78                    | Not applicable               |
| 01 46                    | Not applicable               |
| 01 14                    | Not applicable               |
| 00 78                    | Not applicable               |
| 00 46                    | Not applicable               |
| 00 14                    | Not applicable               |

## Structure

The fields described below are REQUIRED to be specified by algorithm suites, unless otherwise specified.

### Algorithm Suite ID

A 2-byte hex value that uniquely identifies an algorithm suite.

### Encryption Algorithm

The block cipher encryption algorithm.

The length of the input encryption key MUST equal the [encryption key length](#encryption-key-length) specified by the algorithm suite.

#### Supported Encryption Algorithms

- [AES](#aes)

### Encryption Algorithm Mode

The AEAD operation mode used with the encryption algorithm.

The length of the input IV MUST equal the IV length specified by the algorithm suite.
The length of the authentication tag MUST equal the authentication tag length specified by the algorithm suite.

#### Supported Encryption Algorithm Modes

- [GCM](#gcm)

### Encryption Key Length

The length of the encryption key used as input to the encryption algorithm.

### IV Length

The length of the initialization vector (IV) used with the encryption algorithm.

### Authentication Tag Length

The length of the authentication tag used with AEAD.

### Encryption Key Derivation Algorithm

This key derivation algorithm defines what key derivation function (KDF) to use for encryption key generation.
The specified KDF algorithm MUST be used to generate the encryption algorithm encryption key input.

#### Supported Encryption Key Derivation Algorithms

- [Identity KDF](#identity-kdf)
- [HKDF](#hkdf-encryption-key)

### Key Derivation Input Length

The length of the input to the Key Derivation Algorithm.

### Key Commitment

AES-GCM is not key committing by default.
Key commitment is a property,
which ensures that exactly one data key can be used to decrypt a ciphertext.
However, not all algorithm suites provide this property.

#### Supported Key Commitment Values

- True
- False

### Commit Key

A key that is used to provide [key commitment](#key-commitment) to AES-GCM.

### Commit Key Derivation Algorithm

This key derivation algorithm defines what key derivation function (KDF) to use for commitment key generation.
The specified KDF algorithm MUST be used to generate the [commit key](#commit-key).

#### Supported Commit Key Derivation Algorithm

- [HKDF](#hkdf-commit-key)

### Commit Key Length

The length of the commit key used to verify [key commitment](#key-commitment).

### Signature Algorithm

This field is OPTIONAL.

The signature algorithm defines what algorithm to use for signature generation and verification.

If the algorithm suite includes a signature algorithm:

- Signatures MUST be generated using the specified signature algorithm.
- Signatures MUST be verified using the specified signature algorithm.

If the algorithm suite does not include a signature algorithm:

- Signatures MUST NOT be generated.
- Signatures MUST NOT be verified.

#### Supported Signature Algorithms

- [ECDSA with P256 and SHA256](#ecdsa)
- [ECDSA with P384 and SHA384](#ecdsa)

### Message Format Version

Indicates the message format version for the supported algorithm suite.

#### Supported Message Format Version

- 1.0
- 2.0

### Algorithm Suite Data

Algorithm suites may capture a variable-per-algorithm-suite length of data
relevant to that algorithm suite’s mode of operation.

#### Supported Algorithm Suite Data

- Algorithm Suite 05 78 MUST store the commit key in the suite data
- Algorithm Suite 04 78 MUST store the commit key in the suite data

### Algorithm Suite Data Length

Then length of the [algorithm suite data](#algorithm-suite-data).
The field is always present in message format 2.0,
but its length and contents are determined by the algorithm suite.
The field MAY be length 0.

#### Supported Algorithm Suite Data Lengths

- 32

## Security Considerations

### Which algorithm suite should I use?

You should use the default algorithm suite.

You should use an algorithm suite that supports key commitment.

You may use the non-default AES-GCM with key derivation and signing key algorithm suites
if key derivation input lengths of other sizes are required.

If the users who encrypt and the users who decrypt are equally trusted,
you may use AES-GCM with only key derivation algorithm suites.

You should not use AES-GCM with only key derivation algorithm suites
if the users who encrypt and the users who decrypt are not equally trusted.

You should not use AES-GCM without key Derivation or signing,
except for backwards compatibility.
